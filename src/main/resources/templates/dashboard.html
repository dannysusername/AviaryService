<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta name="viewport" content="width=device-width">
    <title>Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/dashboardstyle.css}" href="/Users/danieli/Documents/Projects/aviaryservice/src/main/resources/static/css/dashboardstyle.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script th:src="@{/js/dashboard.js}"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://kit.fontawesome.com/647fe92b87.js" crossorigin="anonymous"></script>
</head>
<body>

    
    <header class="fixed-header">
        <div class="header-left">
            <h1 class="print-remove">Aviary</h1>
        </div>
        <div class="header-right">
            <form method="post" th:action="@{/logout}" class="no-print">
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </div>
    </header>

    <div class = "header">
        <div class = "buttons">
            <!--<button id="export-excel" class="no-print">Export to Excel</button> -->
            <button id="print-dashboard" class="no-print">Print Dashboard</button>
        </div>

        <!--Hobbs hours and Tach hours display and edit-->
        <div class="my-hours">
            <h3>My Hours</h3>
            <div class="hours-display-and-editbutton-container">
                <span class="current-hobbs-display" id="current-hobbs-display" th:text="'Hobbs Time: ' + ${hobbsHours}"></span>
                <span class="current-tach-display" id="current-tach-display" th:text="'Tach Time: ' + ${tachHours}"></span>
                <button class="edit-hours-btn no-print">Edit</button>
            </div>
            <div class="edit-hours-section no-print" style="display: none;">
                <div class="hours-edit-row">
                    <label>Edit Hobbs:</label>
                    <input type="number" id="current-hobbs" th:value="${hobbsHours}" step="0.1" min="0" placeholder="Edit current Hobbs">
                </div>
                <div class="hours-edit-row">
                    <label>Edit Tach:</label>
                    <input type="number" id="current-tach" th:value="${tachHours}" step="0.1" min="0" placeholder="Edit current Tach">
                </div>
                <div class="hours-add-row">
                    <span>Add Hobbs:</span>
                    <input type="number" id="add-hobbs-time" step="0.1" placeholder="Enter Hobbs to add">
                    <button id="add-hobbs-btn" class="add-btn">Add Hobbs</button>
                </div>
                <div class="hours-add-row">
                    <span>Add Tach:</span>
                    <input type="number" id="add-tach-time" step="0.1" placeholder="Enter Tach to add">
                    <button id="add-tach-btn" class="add-btn">Add Tach</button>
                </div>
            </div>
        </div>
    </div>

    <div class="tabs no-print">
        <button class="tab-button active" data-tab="service-tab">Service Timeline</button>
        <button class="tab-button" data-tab="logbook-tab">Log Book</button>
    </div>

    <!-- New aircraft info table -->

    <div id="service-tab" class="tab-content">
        <h2 class="print-only tab-print-title">Service Timeline</h2>
        <div class = "main">
            <table class="aircraft-info-table">
                <tbody>
                    <tr>
                        <td class = "make-model-tag">Make/Model:</td>
                        <td><input type="text" name="makeModel" autocomplete="makeModel" class="user-info-input no-print" th:value="${makeModel}" placeholder="Make/Model "><span class="print-only" th:text="${makeModel}"></span></td>
                    </tr>
                    <tr>
                        <td class = "tail-number-tag">Tail Number:</td>
                        <td><input type="text" name="tailNumber" autocomplete="tail-number-tag" class="user-info-input no-print" th:value="${tailNumber}" placeholder="Tail Number"><span class="print-only" th:text="${tailNumber}"></span></td>
                    </tr>
                    <tr>
                        <td class = "owner-tag">Owner:</td>
                        <td><input type="text" name="ownerName" autocomplete="ownerName" class="user-info-input no-print" th:value="${ownerName}" placeholder="Owner "><span class="print-only" th:text="${ownerName}"></span></td>
                    </tr>
                    <tr>
                        <td class = "make-model-s\n-tag">Make/model S/N:</td>
                        <td><input type="text" name="makeModelSN" autocomplete="make-model-s\n-tag" class="user-info-input no-print" th:value="${makeModelSN}" placeholder="Make/Model S/N"><span class="print-only" th:text="${makeModelSN}"></span></td>
                    </tr>
                </tbody>
            </table>

            <!-- Existing first table follows here -->
            <table>
                <thead class = "sortable-head">
                    <tr>
                        <th class = "grip-column no-print"></th> <!-- Grip column hidden in print -->
                        <th class = "print">Item</th>
                        <th class = "print">Description</th>
                        <th class = "print">Cycle</th>
                        <th class = "print">Last Done</th>
                        <th class = "print">Due Date</th>
                        <th class = "print">Time Left</th>
                        <!--<th class = "status-header">Status</th>-->
                        <th class = "delete-header"></th>
                    </tr>
                </thead>
                <tbody class = "sortable">
                    <!-- Existing timelines 
                    Where title rows or item rows are dynamically rendered,  
                    -->

                    <th:block th:each="timeline : ${timelines}">
                        <!-- Title row -->
                        <tr th:if="${timeline.isTitle}" class="title-row" th:data-id="${timeline.id}">
                            <td class = "grip-cell"><span class="grip-icon no-print"><i class="fa-solid fa-grip-vertical"></span></td>
                            <td colspan="6" class="title-cell" th:text="${timeline.item}"></td>
                            <td class="delete-cell"><span class="delete-icon no-print" onclick="deleteRow(this)"><i class="fa-solid fa-trash-can fa-xl"></i></span></td>
                        </tr>
                        <!-- Regular item row -->
                        <tr th:unless="${timeline.isTitle}" th:data-id="${timeline.id}" th:data-lastDone="${timeline.lastDone}" th:data-dueDate="${timeline.dueDate}" th:data-cycle="${timeline.cycle}" class="auto-save-row">                           
                            <td class = "grip-cell"><span class="grip-icon no-print"><i class="fa-solid fa-grip-vertical"></span></i></td>
                            <td><textarea name="item" th:text="${timeline.item}" oninput="autoSave(this)" class="no-print"></textarea>
                                <span class="print-only" th:text="${timeline.item}"></span></td>
                            <td>
                                <div class="custom-dropdown no-print">
                                    <div class="selected-option no-print"></div>
                                    <input type="hidden" name="description" th:value="${timeline.description}">
                                    <i class="fa-solid fa-chevron-down trigger-dropdown"></i>
                                    <div class="dropdown-options no-print">
                                        <div class="option" data-value="">--None--</div>
                                        <div class="option" data-value="Inspect">Inspect</div>
                                        <div class="option" data-value="Test">Test</div>
                                        <div class="option" data-value="Replace">Replace</div>
                                        <div class="option" data-value="Overhaul">Overhaul</div>
                                        <div th:each="option : ${descriptionOptions}" class="option custom-option" th:data-value="${option.option}" th:data-option-id="${option.id}">
                                            <span th:text="${option.option}"></span>
                                            <button class="remove-option-btn" th:data-option-id="${option.id}"><i class="fa-solid fa-xmark"></i></button>
                                        </div>
                                        <div class="add-option-container">
                                            <input type="text" class="custom-description" placeholder="New option">
                                            <button class="add-option-btn" onclick="addCustomDescription(this)">Add</button>
                                        </div>
                                    </div>
                                </div>
                                <span class="print-only" th:text="${timeline.description}"></span>
                            </td>
                            <td><textarea name="cycle" oninput="autoSave(this)" th:text="${timeline.cycle}" class="no-print"></textarea><span class="print-only" th:text="${timeline.cycle}"></span></td>
                            <td>
                                <div class="input-with-dropdown no-print">
                                    <i class="fa-solid fa-chevron-down trigger-dropdown"></i>
                                    <div class="type-dropdown" style="display: none;">
                                        <div class="type-option">
                                            <span>Calendar</span>
                                            <button class="add-type" data-type="calendar">+</button>
                                        </div>
                                        <div class="type-option">
                                            <span>Clock</span>
                                            <button class="add-type" data-type="clock">+</button>
                                        </div>
                                    </div>
                                </div>
                                <span class="print-only" th:text="${timeline.lastDone}"></span>
                            </td>
                            <td>
                                <div class="input-with-dropdown no-print">
                                    <i class="fa-solid fa-chevron-down trigger-dropdown"></i>
                                    <div class="type-dropdown" style="display: none;">
                                        <div class="type-option">
                                            <span>Calendar</span>
                                            <button class="add-type" data-type="calendar">+</button>
                                        </div>
                                        <div class="type-option">
                                            <span>Clock</span>
                                            <button class="add-type" data-type="clock">+</button>
                                        </div>
                                    </div>
                                </div>
                                <span class="print-only" th:text="${timeline.dueDate}"></span>
                            </td>
                            <td><div class="time-left" th:text="${timeline.timeLeft != null ? timeline.timeLeft : ''}"></div></td>
                            <!--<td class="status-cell"><span class="save-status no-print">âœ“</span></td>-->
                            <td class="delete-cell"><span class="delete-icon no-print" onclick="deleteRow(this)"><i class="fa-solid fa-trash-can fa-xl"></i></span></td>
                        </tr>
                    </th:block>
                </tbody>
                    
                <tbody>
                    <tr class="add-row no-print"> <!-- Add row -->
                        <td class="grip-column"></td>
                        <td>
                            <div class="row-type-selector"> <!--Choose Item/Title-->
                                <span class="row-type-option" data-type="item" onclick="selectRowType('item', this)">Item</span> <!-- Item button -->
                                <span class="row-type-option" data-type="title" onclick="selectRowType('title', this)">Title</span> <!-- Title button -->
                            </div>
                            <div id="itemInput" style="display: none;"> <!--"Enter Item" item textarea div-->
                                <textarea name="item" placeholder="Enter item"></textarea> <!--Item textarea-->
                            </div>
                            <div id="titleInput" style="display: none;"> <!--"Enter Title" title -->
                                <input type="text" name="title" placeholder="Enter title" class="title-input">
                            </div>
                            <input type="hidden" name="item" id="itemHidden">
                            <input type="hidden" name="isTitle" id="isTitleHidden" value="false">
                        </td>
                        <td>
                            <div class="custom-dropdown no-print">
                                <div class="selected-option no-print"></div>
                                <input type="hidden" name="description" value="">
                                <i class="fa-solid fa-chevron-down trigger-dropdown"></i>
                                <div class="dropdown-options" style="display: none;">
                                    <div class="option" data-value="">--None--</div>
                                    <div class="option" data-value="Inspect">Inspect</div>
                                    <div class="option" data-value="Test">Test</div>
                                    <div class="option" data-value="Replace">Replace</div>
                                    <div class="option" data-value="Overhaul">Overhaul</div>
                                    <div th:each="option : ${descriptionOptions}" class="option custom-option" th:data-value="${option.option}" th:data-option-id="${option.id}">
                                        <span th:text="${option.option}"></span>
                                        <button class="remove-option-btn" th:data-option-id="${option.id}">x</button>
                                    </div>
                                    <div class="add-option-container">
                                        <input type="text" class="custom-description" placeholder="New option">
                                        <button class="add-option-btn" onclick="addCustomDescription(this)">Add</button>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><textarea placeholder = "Service cycle time. Ex. 100 hours" name="cycle"></textarea></td>
                        <td>
                            <div class="input-with-dropdown">
                                <i class="fa-solid fa-chevron-down trigger-dropdown"></i>
                                <div class="type-dropdown" style="display: none;">
                                    <div class="type-option"><span>Calendar</span><button type="button" class="add-type" data-type="calendar">+</button></div>
                                    <div class="type-option"><span>Clock</span><button type="button" class="add-type" data-type="clock">+</button></div>
                                </div>
                            </div>
                            <input type="hidden" name="lastDone" id="lastDoneHidden">
                        </td>
                        <td>
                            <div class="input-with-dropdown">
                                <i class="fa-solid fa-chevron-down trigger-dropdown"></i>
                                <div class="type-dropdown" style="display: none;">
                                    <div class="type-option"><span>Calendar</span><button type="button" class="add-type" data-type="calendar">+</button></div>
                                    <div class="type-option"><span>Clock</span><button type="button" class="add-type" data-type="clock">+</button></div>
                                </div>
                            </div>
                            <input type="hidden" name="dueDate" id="dueDateHidden">
                        </td>
                        <td><div class="time-left"></div></td>
                        <!--<td class="status-cell"><span class="save-status"></span></td>-->
                        <td class="add-cell">
                            <form method="post" th:action="@{/dashboard}">
                                <input type="hidden" name="item" id="itemHiddenDuplicate">
                                <input type="hidden" name="isTitle" id="isTitleHiddenDuplicate" value="false">
                                <input type="hidden" name="description" id="descriptionHidden">
                                <input type="hidden" name="cycle" id="cycleHidden">
                                <input type="hidden" name="lastDone" id="lastDoneHiddenDuplicate">
                                <input type="hidden" name="dueDate" id="dueDateHiddenDuplicate">
                                <input type="hidden" name="timeLeft" id="timeLeftHidden">
                                <button type="submit" class="add-button">Add</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="logbook-tab" class="tab-content">
        <h2 class="print-only tab-print-title">Flight Logs</h2>
        <div class="main">
            <table class="logbook-table">
                <thead>
                    <tr>
                        <th>From</th>
                        <th>To</th>
                        <th>Hobbs In</th>
                        <th>Hobbs Out</th>
                        <th>Tach In</th>
                        <th>Tach Out</th>
                        <th class="delete-header"></th>
                    </tr>
                </thead>
                <tbody id="logbook-body">
                    <tr th:each="log : ${flightlogs}" class="log-row" th:data-id="${log.id}">
                        <td data-label="From">
                            <span class="print-only" th:text="${log.fromAirport}"></span>
                            <input type="text" name="fromAirport" class="no-print" th:value="${log.fromAirport}" readonly>
                        </td>
                        <td data-label="To">
                            <span class="print-only" th:text="${log.toAirport}"></span>
                            <input type="text" name="toAirport" class="no-print" th:value="${log.toAirport}" readonly>
                        </td>
                        <td data-label="Hobbs In">
                            <span class="print-only" th:text="${log.hobbsIn}"></span>
                            <input type="number" name="hobbsIn" class="no-print" th:value="${log.hobbsIn}" readonly step="0.1">
                        </td>
                        <td data-label="Hobbs Out">
                            <span class="print-only" th:text="${log.hobbsOut}"></span>
                            <input type="number" name="hobbsOut" class="no-print" th:value="${log.hobbsOut}" readonly step="0.1">
                        </td>
                        <td data-label="Tach In">
                            <span class="print-only" th:text="${log.tachIn}"></span>
                            <input type="number" name="tachIn" class="no-print" th:value="${log.tachIn}" readonly step="0.1">
                        </td>
                        <td data-label="Tach Out">
                            <span class="print-only" th:text="${log.tachOut}"></span>
                            <input type="number" name="tachOut" class="no-print" th:value="${log.tachOut}" readonly step="0.1">
                        </td>
                        <td class="delete-cell no-print" data-label="">
                            <button class="delete-log-icon"><i class="fa-solid fa-trash-can fa-xl"></i></button>
                        </td>
                    </tr>
                    <!-- NEW: Add row for new log -->
                    <tr class="add-log-row no-print">
                        <td data-label="From"><input type="text" id="fromAirport" name="fromAirport" autocomplete="fromAirport" placeholder="From Airport"></td>
                        <td data-label="To"><input type="text" id="toAirport" name="toAirport" autocomplete="toAirport" placeholder="To Airport"></td>
                        <td data-label="Hobbs In"><input type="number" id="hobbsIn" name="hobbsIn" autocomplete="hobbsIn" placeholder="Hobbs In" step="0.1"></td>
                        <td data-label="Hobbs Out"><input type="number" id="hobbsOut" name="hobbsOut" autocomplete="hobbsOut" placeholder="Hobbs Out" step="0.1"></td>
                        <td data-label="Tach In"><input type="number" id="tachIn" name="tachIn" autocomplete="tachIn" placeholder="Tach In" step="0.1"></td>
                        <td data-label="Tach Out"><input type="number" id="tachOut" name="tachOut" autocomplete="tachOut" placeholder="Tach Out" step="0.1"></td>
                        <td class="add-cell" data-label="">
                            <button id="add-log-button" class="add-log-button">Add</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
</body>
</html>